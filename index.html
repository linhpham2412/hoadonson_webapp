<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√≥a ƒê∆°n S∆°n - PUKACO</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#4361ee">
</head>
<body>
<div class="invoice-box">
    <div class="header">
        <div class="logo">
            <img src="pukaco.png" alt="Pukaco Logo" class="logo-image">
        </div>
        <div class="company-info">
            <h4>C√îNG TY TNHH PUKACO</h4>
            <p class="company-address">Phan VƒÉn Tr·ªã, Ph∆∞·ªùng 10, Qu·∫≠n G√≤ V·∫•p, Th√†nh ph·ªë H·ªì Ch√≠ Minh, Vi·ªát Nam</p>
        </div>
    </div>

    <div class="invoice-header">
        <div class="invoice-title">
            <h4>H√ìA ƒê∆†N B√ÅN H√ÄNG</h4>
        </div>
    </div>

    <div class="customer-section">
        <div class="table-container">
            <table class="customer-info">
                <tr>
                    <td class="info-label" data-label="T√™n kh√°ch h√†ng">T√™n kh√°ch h√†ng:</td>
                    <td data-label="Input t√™n KH">
                        <div class="input-container">
                            <input type="text" class="borderless-input" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng">
                        </div>
                    </td>
                    <td class="invoice-date" data-label="Ng√†y">Ng√†y:</td>
                    <td data-label="Ng√†y"><span id="invoice-date">Loading...</span></td>
                </tr>
                <tr>
                    <td class="info-label">ƒê·ªãa ch·ªâ:</td>
                    <td>
                        <div class="input-container">
                            <textarea class="borderless-input multiline" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ"></textarea>
                        </div>
                    </td>
                    <td class="info-label">S·ªë:</td>
                    <td class="info-label">BH000481</td>
                </tr>
                <tr>
                    <td class="info-label">M√£ S·ªë Thu·∫ø:</td>
                    <td><input type="text" class="borderless-input" placeholder="Nh·∫≠p m√£ s·ªë thu·∫ø"></td>
                    <td class="info-label">Lo·∫°i ti·ªÅn:</td>
                    <td class="info-label">VND</td>
                </tr>
                <tr>
                    <td class="info-label">Di·ªÖn Gi·∫£i:</td>
                    <td>
                        <div class="input-container">
                            <textarea class="borderless-input multiline" placeholder="Nh·∫≠p di·ªÖn gi·∫£i"></textarea>
                        </div>
                    </td>
                    <td><span class="info-label">Hotline:</span></td>
                    <td><span class="info-hotline">0903 384 597</span></td>
                </tr>
            </table>
        </div>
    </div>

    <div class="products-section">
        <h3 class="section-title">Chi ti·∫øt s·∫£n ph·∫©m/d·ªãch v·ª•</h3>
        <div class="table-container">
            <table class="products-table">
                <thead>
                <tr>
                    <th>M√£ H√†ng</th>
                    <th>T√™n H√†ng</th>
                    <th>ƒê∆°n V·ªã</th>
                    <th>S·ªë L∆∞·ª£ng</th>
                    <th>ƒê∆°n Gi√°</th>
                    <th>Th√†nh Ti·ªÅn</th>
                    <th>Ph√≠ Kh√°c (%,VND)</th>
                </tr>
                </thead>
                <tbody id="invoice-items">
                <!-- Items will be added via JavaScript -->
                </tbody>
                <tfoot>
                <tr>
                    <td colspan="5" class="total-label">T·ªïng c·ªông:</td>
                    <td class="total-amount" id="invoice-total">0 ‚Ç´</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="5" class="tax-label">Thu·∫ø VAT (10%):</td>
                    <td class="tax-amount" id="invoice-tax">0 ‚Ç´</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="5" class="grand-total-label">T·ªïng thanh to√°n:</td>
                    <td class="grand-total-amount" id="invoice-grand-total">0 ‚Ç´</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="2" class="vietnamese-total-label">B·∫±ng ch·ªØ:</td>
                    <td colspan="5" class="vietnamese-total-amount" id="invoice-grand-total-text">Kh√¥ng ƒë·ªìng</td>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="footer">
        <div class="payment-info">
            <h4>Th√¥ng tin thanh to√°n</h4>
            <div class="bank-info">
                <p><strong>Ng√¢n h√†ng:</strong> Vietcombank</p>
                <p><strong>S·ªë t√†i kho·∫£n:</strong> 0123456789</p>
                <p><strong>Ch·ªß t√†i kho·∫£n:</strong> C√îNG TY TNHH PUKACO</p>
            </div>
        </div>
        <div class="signature">
            <div class="signature-box">
                <p class="signature-line">Ng∆∞·ªùi mua h√†ng</p>
                <p class="signature-name">(K√Ω v√† ghi r√µ h·ªç t√™n)</p>
                <div class="signature-space"></div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="print-btn" onclick="window.print()">
            <span class="btn-icon">üñ®Ô∏è</span> In h√≥a ƒë∆°n
        </button>
        <button class="save-btn" id="saveInvoice">
            <span class="btn-icon">üíæ</span> L∆∞u h√≥a ƒë∆°n
        </button>
        <button class="products-btn" onclick="window.location.href='products.html'">
            <span class="btn-icon">üìã</span> Qu·∫£n l√Ω s·∫£n ph·∫©m
        </button>
    </div>
</div>

<script>
    // Sample invoice items
    const items = [
        {
            code: "SP001",
            name: "S∆°n cao c·∫•p m√†u tr·∫Øng",
            unit: "Th√πng",
            quantity: 5,
            price: 350000,
            fee: "5%"
        },
        {
            code: "SP002",
            name: "S∆°n ch·ªëng th·∫•m ngo·∫°i th·∫•t",
            unit: "Th√πng",
            quantity: 2,
            price: 420000,
            fee: "10,000 ‚Ç´"
        },
        {
            code: "SP003",
            name: "Ch·ªïi s∆°n chuy√™n d·ª•ng",
            unit: "C√°i",
            quantity: 3,
            price: 120000,
            fee: "0"
        }
    ];

    // Initialize when page loads
    window.onload = function() {
        initializeInvoice();
    };

    // Set today's date in Vietnamese format with month name
    const today = new Date();
    const day = today.getDate();
    const month = today.getMonth();
    const year = today.getFullYear();

    const monthNamesVietnamese = [
        "th√°ng 1", "th√°ng 2", "th√°ng 3", "th√°ng 4", "th√°ng 5", "th√°ng 6",
        "th√°ng 7", "th√°ng 8", "th√°ng 9", "th√°ng 10", "th√°ng 11", "th√°ng 12"
    ];

    document.getElementById('invoice-date').textContent =
        `${day.toString().padStart(2, '0')} ${monthNamesVietnamese[month]} ${year}`;

    // Add this JavaScript to auto-expand textareas
    document.querySelectorAll('.borderless-input.multiline').forEach(input => {
      input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
    });

    // Function to get products from localStorage
    function getProductsFromStorage() {
        const savedProducts = localStorage.getItem('pukaco-products');
        return savedProducts ? JSON.parse(savedProducts) : [];
    }

    // Function to create dropdown for product selection
    function createProductDropdown() {
        const products = getProductsFromStorage();
        const productNameCells = document.querySelectorAll('td[data-label="T√™n H√†ng"]');

        productNameCells.forEach(cell => {
            // Skip if dropdown already exists
            if (cell.querySelector('.product-dropdown')) return;

            const currentValue = cell.textContent.trim();
            const dropdown = document.createElement('div');
            dropdown.className = 'product-dropdown';

            // Create the button
            const button = document.createElement('button');
            button.className = 'dropbtn';
            button.textContent = currentValue || 'Ch·ªçn s·∫£n ph·∫©m';

            // Create dropdown content
            const dropdownContent = document.createElement('div');
            dropdownContent.className = 'dropdown-content';

            // Add product options
            products.forEach(product => {
                const option = document.createElement('a');
                option.href = '#';
                option.textContent = product.name;
                option.onclick = function(e) {
                    e.preventDefault();
                    button.textContent = product.name;
                    // Update the entire row with product details
                    const row = cell.parentElement;
                    row.querySelector('td[data-label="M√£ H√†ng"]').textContent = product.code;
                    row.querySelector('td[data-label="ƒê∆°n V·ªã"]').textContent = product.unit;
                    row.querySelector('td[data-label="ƒê∆°n Gi√°"]').textContent =
                        product.price.toLocaleString('vi-VN') + ' ‚Ç´';

                    // Calculate and update the total
                    const quantityCell = row.querySelector('td[data-label="S·ªë L∆∞·ª£ng"]');
                    const quantity = parseInt(quantityCell.textContent) || 0;
                    const total = quantity * product.price;
                    row.querySelector('td[data-label="Th√†nh Ti·ªÅn"]').textContent =
                        total.toLocaleString('vi-VN') + ' ‚Ç´';

                    // Recalculate all totals
                    calculateTotals();
                };
                dropdownContent.appendChild(option);
            });

            // Add "Add new" option
            const addNew = document.createElement('a');
            addNew.href = 'products.html';
            addNew.textContent = '+ Th√™m s·∫£n ph·∫©m m·ªõi';
            dropdownContent.appendChild(addNew);

            dropdown.appendChild(button);
            dropdown.appendChild(dropdownContent);
            cell.innerHTML = '';
            cell.appendChild(dropdown);
        });
    }

    // Function to calculate all totals
    function calculateTotals() {
        let subtotal = 0;
        const rows = document.querySelectorAll('#invoice-items tr');

        rows.forEach(row => {
            const quantity = parseInt(row.querySelector('td[data-label="S·ªë L∆∞·ª£ng"]').textContent) || 0;
            const priceText = row.querySelector('td[data-label="ƒê∆°n Gi√°"]').textContent;
            const price = parseInt(priceText.replace(/[^\d]/g, '')) || 0;
            const total = quantity * price;

            // Update the total cell
            row.querySelector('td[data-label="Th√†nh Ti·ªÅn"]').textContent =
                total.toLocaleString('vi-VN') + ' ‚Ç´';

            subtotal += total;
        });

        // Update summary totals
        const tax = subtotal * 0.1; // 10% VAT
        const grandTotal = subtotal + tax;

        document.getElementById('invoice-total').textContent = `${subtotal.toLocaleString('vi-VN')} ‚Ç´`;
        document.getElementById('invoice-tax').textContent = `${tax.toLocaleString('vi-VN')} ‚Ç´`;
        document.getElementById('invoice-grand-total').textContent = `${grandTotal.toLocaleString('vi-VN')} ‚Ç´`;
        document.getElementById('invoice-grand-total-text').textContent = numberToVietnameseText(grandTotal);
    }

    // Function to add a new empty row
    function addNewRow() {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td data-label="M√£ H√†ng"></td>
            <td data-label="T√™n H√†ng"></td>
            <td data-label="ƒê∆°n V·ªã"></td>
            <td data-label="S·ªë L∆∞·ª£ng" contenteditable="true">1</td>
            <td data-label="ƒê∆°n Gi√°">0 ‚Ç´</td>
            <td data-label="Th√†nh Ti·ªÅn">0 ‚Ç´</td>
            <td data-label="Ph√≠ Kh√°c">0</td>
        `;
        document.getElementById('invoice-items').appendChild(row);
        createProductDropdown();

        // Add event listener for quantity changes
        row.querySelector('td[data-label="S·ªë L∆∞·ª£ng"]').addEventListener('input', function() {
            const priceText = row.querySelector('td[data-label="ƒê∆°n Gi√°"]').textContent;
            const price = parseInt(priceText.replace(/[^\d]/g, '')) || 0;
            const quantity = parseInt(this.textContent) || 0;
            const total = quantity * price;
            row.querySelector('td[data-label="Th√†nh Ti·ªÅn"]').textContent =
                total.toLocaleString('vi-VN') + ' ‚Ç´';
            calculateTotals();
        });
    }

    // Initialize the invoice with sample data and dropdowns
    function initializeInvoice() {
        // Clear existing rows
        document.getElementById('invoice-items').innerHTML = '';

        // Add sample rows
        items.forEach(item => {
            const row = document.createElement('tr');
            const itemTotal = item.quantity * item.price;

            row.innerHTML = `
                <td data-label="M√£ H√†ng">${item.code}</td>
                <td data-label="T√™n H√†ng">${item.name}</td>
                <td data-label="ƒê∆°n V·ªã">${item.unit}</td>
                <td data-label="S·ªë L∆∞·ª£ng" contenteditable="true">${item.quantity}</td>
                <td data-label="ƒê∆°n Gi√°">${item.price.toLocaleString('vi-VN')} ‚Ç´</td>
                <td data-label="Th√†nh Ti·ªÅn">${itemTotal.toLocaleString('vi-VN')} ‚Ç´</td>
                <td data-label="Ph√≠ Kh√°c">${item.fee}</td>
            `;
            document.getElementById('invoice-items').appendChild(row);

            // Add event listener for quantity changes
            row.querySelector('td[data-label="S·ªë L∆∞·ª£ng"]').addEventListener('input', function() {
                const quantity = parseInt(this.textContent) || 0;
                const total = quantity * item.price;
                row.querySelector('td[data-label="Th√†nh Ti·ªÅn"]').textContent =
                    total.toLocaleString('vi-VN') + ' ‚Ç´';
                calculateTotals();
            });
        });

        // Add a button to add new rows
        const addRowBtn = document.createElement('button');
        addRowBtn.textContent = '+ Th√™m d√≤ng';
        addRowBtn.className = 'add-row-btn';
        addRowBtn.onclick = addNewRow;
        document.querySelector('.products-section').appendChild(addRowBtn);

        // Create dropdowns
        createProductDropdown();
    }


    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('ServiceWorker registered'))
                .catch(err => console.log('ServiceWorker error:', err));
        });
    }

    // Add this function to convert numbers to Vietnamese text
    function numberToVietnameseText(total) {
        const digits = ['kh√¥ng', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n'];
        const units = ['', 'ngh√¨n', 'tri·ªáu', 't·ª∑'];
        if (total === 0) return 'Kh√¥ng ƒë·ªìng';
        let result = '';
        let unitIndex = 0;
        let remaining = total;
        while (remaining > 0) {
            const chunk = remaining % 1000;
            remaining = Math.floor(remaining / 1000);
            if (chunk !== 0) {
                let chunkText = '';
                const hundred = Math.floor(chunk / 100);
                const ten = Math.floor((chunk % 100) / 10);
                const one = chunk % 10;
                if (hundred > 0) {
                    chunkText += digits[hundred] + ' trƒÉm ';
                }
                if (ten > 0) {
                    if (ten === 1) {
                        chunkText += 'm∆∞·ªùi ';
                    } else {
                        chunkText += digits[ten] + ' m∆∞∆°i ';
                    }
                }
                if (one > 0) {
                    if (ten > 0 && one === 1) {
                        chunkText += 'm·ªët ';
                    } else if (ten === 0 && hundred !== 0 && one === 5) {
                        chunkText += 'lƒÉm ';
                    } else if (one === 5) {
                        chunkText += 'nƒÉm ';
                    } else if (ten > 1 && one === 1) {
                        chunkText += 'm·ªët ';
                    } else {
                        chunkText += digits[one] + ' ';
                    }
                }
                chunkText += units[unitIndex] + ' ';
                result = chunkText + result;
            }
            unitIndex++;
        }
        return result.charAt(0).toUpperCase() + result.slice(1).trim() + ' ƒë·ªìng';
    }

    // Update the totals calculation to include Vietnamese text
    document.getElementById('invoice-grand-total-text').textContent = numberToVietnameseText(grandTotal);

    // Save invoice functionality
    document.getElementById('saveInvoice').addEventListener('click', function() {
        alert('H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
        // Here you would typically send data to server or save locally
    });
</script>
</body>
</html>